# v1.2.6 - 2026-02-17

This patch fixes a rollback bug that created duplicate version entries, eliminates flaky test failures from SQLite lock contention, and adds Windows cross-compilation support.

## Bug fixes

### Rollback duplicate version entries
Rolling back to a previous version was creating **two** new version records (an "update" followed by a "rollback") instead of just one. This happened because `ApplyVersionByName` called `ReplaceCommands` — which internally records an "update" version — and then separately recorded a "rollback" version.

**Fix:** `ApplyVersionByName` now performs the command replacement and version recording in a **single transaction** using `replaceCommandsTx` + `recordVersionTx`, so only one "rollback" version entry is created.

### Version preview not updating after a run
After running a command (R), stale run logs overrode the left panel content when switching panes or pressing Enter on a version in the versions panel. This meant:
- Pressing Enter on a version appeared to do nothing
- Switching to the versions pane didn't update the left panel preview
- Switching back to the left panel didn't restore the original detail

**Fix:** Run logs are now cleared when navigating between panes (left/right arrow, Tab) or pressing Enter on a version. This allows the version preview and original command set detail to display correctly.

### Flaky test failures (SQLite lock contention)
Multiple test packages (`registry`, `tui/model`, `tui/adapters`) were sharing the same SQLite database file, causing intermittent "database is locked" errors when `go test ./...` ran them in parallel.

**Fix:** Added a shared `setupTestDB` helper that isolates each test to its own temporary database via the `KRNR_DB` environment variable. Applied across all registry, model, and adapter test files.

## Portability

### Windows cross-compilation
Unix-only PTY code (`syscall.SysProcAttr.Setsid`/`Setctty`, `creack/pty`, `golang.org/x/term`) was in the main `executor.go` file, breaking `GOOS=windows` builds.

**Fix:** Split into build-tagged platform files:
- `pty_unix.go` (`//go:build !windows`) — real PTY implementation
- `pty_windows.go` (`//go:build windows`) — safe stubs (`isTerminal` returns false, `ptyStarter` returns error)
- Added `!windows` build tags to PTY-dependent test files

## Tests
- Updated `TestVersions_Rollback` and `TestApplyVersionToNonEmpty` to assert exactly one new version (rollback) is created, not two
- Extracted `assertVersionCount` and `mustGetCommandSet` test helpers to keep gocyclo under 10
- All existing rollback and version tests pass with the fix

## Upgrade notes
- No DB schema changes required.
- Existing version history is unaffected; the fix only prevents future duplicate entries during rollback.
